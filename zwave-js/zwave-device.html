<script type="text/javascript">
	RED.nodes.registerType('zwave-device', {
		category: 'ZWave JS',
		color: 'rgb(46,145,205)',
		defaults: {
			name: { value: 'Some Z-Wave Device' },
			filteredNodeId: { value: 'All' },
			multicast: { value: false },
			datamode: { value: 'Send/Receive' },
			messagesPerMS: { value: 1 },
			messageInterval: { value: 250 },
			outputs: { value: 1 },
			inputs: { value: 1 }
		},
		inputs: 1,
		outputs: 1,
		icon: 'Node.svg',
		label: function () {
			return this.name;
		},
		oneditprepare: SortUI,
		oneditsave: SetIO
	});

	function SetIO() {
		// I/O
		switch ($('#node-input-datamode').val()) {
			case 'Send':
				this.outputs = 0;
				this.inputs = 1;
				break;

			case 'Receive':
				this.outputs = 1;
				this.inputs = 0;
				break;

			default:
				this.outputs = 1;
				this.inputs = 1;
				break;
		}
	}

	function SortUI() {
		let node = this;

		let Rate = $('#drate');
		let Mode = $('#node-input-filteredMode');
		let Filter = $('#node-input-filteredNodeId');
		Rate.css({ display: 'none' });

		// Subflow Options
		const inSubflow = !!RED.nodes.subflow(node.z);
		if (inSubflow) {
			$('#node-input-filteredMode').append(
				new Option('Subflow Variable: ZW_NODE_ID', 'Var')
			);
		}

		// I/O
		if (this.datamode === undefined) {
			$('#node-input-datamode').val('Send/Receive');
		}

		if (this.messagesPerMS === undefined) {
			$('#node-input-messagesPerMS').val(1);
		}
		if (this.messageInterval === undefined) {
			$('#node-input-messageInterval').val(250);
		}

		$.getJSON('zwjsgetnodelist', (data) => {
			Filter.empty();

			let Locations = Object.keys(data);

			Locations.forEach((L) => {
				let Location = data[L];
				if (Location.length > 0) {
					let OG = $('<optgroup label=" --- ' + L + ' --- ">');
					Location.forEach((node) => {
						OG.append(
							new Option(node.id + ' : ' + node.name, node.id.toString())
						);
					});
					Filter.append(OG);
				}
			});

			if (this.filteredNodeId !== undefined) {
				// Single
				if (!isNaN(parseInt(this.filteredNodeId))) {
					Filter.css('height', '');
					Filter.attr('multiple', null);
					Filter.val(this.filteredNodeId);
					Filter.prop('disabled', false);
					Mode.val('Single');
				}

				// Multiple, Multicast
				if (Array.isArray(this.filteredNodeId)) {
					Filter.css('height', '150px');
					Filter.attr('multiple', '');
					Filter.val(this.filteredNodeId);
					Filter.prop('disabled', false);
					if (this.multicast) {
						Mode.val('Multicast');
					} else {
						Mode.val('Multiple');
						Rate.css({ display: 'block' });
					}
				}

				// All
				if (this.filteredNodeId === 'All') {
					Filter.css('height', '');
					Filter.attr('multiple', null);
					Filter.append(new Option('N/A', 'All'));
					Filter.val('All');
					Filter.prop('disabled', true);
					Mode.val('All');
				}

				// As Specifed
				if (this.filteredNodeId === 'AS') {
					Filter.css('height', '');
					Filter.attr('multiple', null);
					Filter.append(new Option('N/A', 'AS'));
					Filter.val('AS');
					Filter.prop('disabled', true);
					Mode.val('Message');
				}

				// Variable
				if (this.filteredNodeId === 'Var') {
					Filter.css('height', '');
					Filter.attr('multiple', null);
					Filter.append(new Option('N/A', 'Var'));
					Filter.val('Var');
					Filter.prop('disabled', true);
					Mode.val('Var');
				}
			} else {
				Filter.attr('multiple', null);
				Filter.css('height', '');
				Filter.append(new Option('N/A', 'All'));
				Filter.val('All');
				Filter.prop('disabled', true);
				Mode.val('All');
			}
		});
	}

	function SortFilterChange() {
		let Mode = $('#node-input-filteredMode');
		let Filter = $('#node-input-filteredNodeId');
		let Rate = $('#drate');
		Rate.css({ display: 'none' });

		switch (Mode.val()) {
			case 'All':
				Filter.css('height', '');
				Filter.find('[value="Select Node"]').remove();
				Filter.find('[value="AS"]').remove();
				Filter.find('[value="Var"]').remove();
				Filter.prepend(new Option('N/A', 'All'));
				Filter.val('All');
				Filter.prop('disabled', true);
				Filter.attr('multiple', null);
				$('#node-input-multicast').prop('checked', false);
				break;

			case 'Message':
				Filter.css('height', '');
				Filter.find('[value="Select Node"]').remove();
				Filter.find('[value="All"]').remove();
				Filter.find('[value="Var"]').remove();
				Filter.prepend(new Option('N/A', 'AS'));
				Filter.val('AS');
				Filter.prop('disabled', true);
				Filter.attr('multiple', null);
				$('#node-input-multicast').prop('checked', false);
				break;

			case 'Multiple':
				Filter.css('height', '150px');
				Filter.find('[value="Select Node"]').remove();
				Filter.find('[value="All"]').remove();
				Filter.find('[value="AS"]').remove();
				Filter.find('[value="Var"]').remove();
				Filter.prop('disabled', false);
				Filter.attr('multiple', '');
				$('#node-input-multicast').prop('checked', false);
				Rate.css({ display: 'block' });
				break;

			case 'Multicast':
				Filter.css('height', '150px');
				Filter.find('[value="Select Node"]').remove();
				Filter.find('[value="All"]').remove();
				Filter.find('[value="AS"]').remove();
				Filter.find('[value="Var"]').remove();
				Filter.prop('disabled', false);
				Filter.attr('multiple', '');
				$('#node-input-multicast').prop('checked', true);
				break;

			case 'Var':
				Filter.css('height', '');
				Filter.find('[value="Select Node"]').remove();
				Filter.find('[value="AS"]').remove();
				Filter.prepend(new Option('N/A', 'Var'));
				Filter.val('Var');
				Filter.prop('disabled', true);
				Filter.attr('multiple', null);
				$('#node-input-multicast').prop('checked', false);
				break;

			default:
				Filter.css('height', '');
				Filter.find('[value="All"]').remove();
				Filter.find('[value="AS"]').remove();
				Filter.find('[value="Var"]').remove();
				Filter.prepend(new Option('Select Node', 'Select Node'));
				Filter.val('Select Node');
				Filter.prop('disabled', false);
				Filter.attr('multiple', null);
				$('#node-input-multicast').prop('checked', false);
				break;
		}
	}
</script>

<script type="text/x-red" data-template-name="zwave-device">

	<input type="checkbox" id="node-input-multicast" style="display: none">

	<p>
	    <strong>Basic settings.</strong><br />
	    Note: This node works in conjunction with the main Z-Wave JS Controller node, therefore, ensure the controller node is in one of your flows and in a deployed state before using this node.
	</p>
	<div class="form-row">
	    <label for="node-input-name" style="width:130px"><i class="fa fa-pencil"></i> Name</label>
	    <input type="text" id="node-input-name" placeholder="My ZWave Node">
	</div>
	<div class="form-row">
	    <label for="node-input-filteredMode" style="width:130px"><i class="fa fa-pencil"></i> Mode</label>
	    <select id="node-input-filteredMode" onchange="SortFilterChange()">
	        <option value="All">All Nodes</option>
	        <option value="Multiple">Multiple Nodes</option>
	        <option value="Multicast">Multicast</option>
	        <option value="Single">Specific Node</option>
	        <option value="Message">As Specified</option>
	    </select>
	</div>
	<div class="form-row" id="drate">
	    <label for="node-input-messagesPerMS" style="width:130px"><i class="fa fa-pencil"></i> Distribution Rate</label>
	    <input style="width:50px" type="text" id="node-input-messagesPerMS" placeholder="1"> node(s) / <input style="width:50px" type="text" id="node-input-messageInterval" placeholder="250"> ms
	</div>
	<div class="form-row">
	    <label for="node-input-datamode" style="width:130px"><i class="fa fa-pencil"></i> Data Mode</label>
	    <select id="node-input-datamode">
	        <option value="Send/Receive">Send/Receive</option>
	        <option value="Send">Send</option>
	        <option value="Receive">Receive</option>
	    </select>
	</div>
	<div class="form-row">
	    <label for="node-input-filteredNodeId" style="width:130px"><i class="fa fa-pencil"></i> Node ID(s)</label>
	    <select id="node-input-filteredNodeId">
	    </select>

	</div>

</script>

<script type="text/x-red" data-help-name="zwave-device">
	    <p>A Z-Wave device node.</p>

	    <p>
	        <code>Input:</code><br />
	        A <strong>payload</strong> object containing a command to send.<br />
	        <strong>params</strong> will be dependant on the type of command you are sending.
	<pre>
	{
	   mode: "CCAPI",
	   cc: "Configuration",
	   method: "set",
	   params: [0x18,0x03,1]
	}
	</pre>
	    </p>

	    <p>
	        <code>Output:</code><br />
	        A <strong>payload</strong> containing an event that has occured within the zwave network.<br />
	        The contents of <strong>object</strong> is dependant on the event.
	<pre>
	{
	   event: "VALUE_UPDATED",
	   timestamp: "23-12-2020T12:23:23+000",
	   object: ...
	}
	</pre>
	    </p>
</script>
